# 兑换码系统使用指南

## 🎁 功能概述

兑换码系统允许管理员生成特殊的兑换码，用户使用兑换码后可以获得额外的使用次数，不受每日10次的限制。

## 🎯 主要特性

- **安全认证**: 管理员需要密钥才能生成兑换码
- **灵活配置**: 可以设置1-100次的任意使用次数
- **一次性使用**: 每个兑换码只能使用一次
- **自动过期**: 兑换码30天后自动过期
- **额外次数**: 兑换获得的次数不会在每日重置时清零

## 🔧 环境配置

在 `.env.local` 文件中添加以下配置：

```env
# 管理员密钥（用于生成兑换码）
ADMIN_KEY="your_secure_admin_key_here"

# 可选：禁用兑换码功能
ENABLE_REDEMPTION=false
```

## 👨‍💼 管理员使用

### 1. 访问管理页面
访问 `/admin` 页面进行兑换码管理

### 2. 生成兑换码
1. 输入管理员密钥（ADMIN_KEY）
2. 设置兑换码价值（1-100次）
3. 可选：添加备注说明
4. 点击生成按钮

### 3. 分发兑换码
- 复制生成的兑换码（格式：ABCD-EFGH-IJKL）
- 分享给需要额外使用次数的用户

## 👤 用户使用

### 1. 兑换码输入
在主页面可以看到兑换码输入区域：

![兑换码输入界面]
- 蓝色渐变框内包含兑换码输入框
- 输入格式：ABCD-EFGH-IJKL（自动转为大写）
- 点击"兑换"按钮提交

### 2. 兑换结果
- ✅ 成功：显示获得的额外次数，使用状态自动更新
- ❌ 失败：显示错误信息（无效、已使用、过期等）

### 3. 使用状态显示
在页面右上角可以看到：
```
今日剩余: 8/10 (+5)
```
- `8/10`: 今日常规次数剩余/总数
- `(+5)`: 额外获得的次数

## 🔄 使用逻辑

### 次数消耗顺序
1. **优先使用常规次数**：先消耗每日10次限额
2. **然后使用额外次数**：常规次数用完后消耗兑换码获得的次数

### 重置机制
- **每日重置**：常规10次在每日凌晨自动重置
- **额外次数保持**：兑换码获得的次数不会重置，一直有效

## 🛠️ API 接口

### 生成兑换码
```
POST /api/admin/generate-code
{
  "value": 5,
  "adminKey": "your_admin_key",
  "description": "活动奖励"
}
```

### 使用兑换码
```
POST /api/redeem-code
{
  "code": "ABCD-EFGH-IJKL"
}
```

### 查询使用状态
```
GET /api/usage-status
```

## 🧹 自动维护

系统自动执行以下清理任务：
- **每日2点**: 清理缓存文件
- **每日3点**: 清理过期使用记录
- **每日4点**: 清理过期兑换码

## 📊 数据存储

- **使用记录**: `data/usage/daily-usage.json`
- **兑换码**: `data/redemption/codes.json`
- **缓存数据**: `data/cache/`

## 🔒 安全考虑

1. **管理员密钥**: 务必设置强密码作为 ADMIN_KEY
2. **IP限制**: 基于IP地址进行使用限制
3. **一次性使用**: 每个兑换码只能使用一次
4. **自动过期**: 30天过期机制防止滥用

## 🎨 自定义配置

在 `lib/constants.ts` 中可以调整：

```typescript
// 兑换码配置
REDEMPTION_CODE_LENGTH: 12,     // 兑换码长度
REDEMPTION_CODE_EXPIRY_DAYS: 30, // 过期天数
MAX_BONUS_USAGE: 100,           // 单次最大增加次数
```

## 🆘 故障排除

### 常见问题

1. **生成失败**: 检查 ADMIN_KEY 是否正确设置
2. **兑换失败**: 确认兑换码格式正确，未过期
3. **次数未增加**: 检查网络连接，刷新页面重试

### 日志查看
管理员可以通过服务器日志查看：
- 兑换码生成记录
- 兑换成功/失败记录  
- 使用次数变化记录

---

🎉 兑换码系统已完整实现，可以灵活为用户提供额外使用机会！